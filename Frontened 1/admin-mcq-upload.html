<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - MCQ Upload | AutoRevise</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="js/config.js"></script>
    <style>
        .upload-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background: #f0f9f0;
            border-color: #45a049;
        }
        
        .upload-area.drag-over {
            background: #e8f5e9;
            border-color: #2e7d32;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #4CAF50;
            margin-bottom: 1rem;
        }
        
        .selected-file {
            margin-top: 1rem;
            padding: 1rem;
            background: #e8f5e9;
            border-radius: 4px;
            display: none;
        }
        
        .upload-btn {
            background: #4CAF50;
            color: white;
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
            display: none;
        }
        
        .upload-btn:hover {
            background: #45a049;
        }
        
        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .results {
            margin-top: 2rem;
            padding: 1rem;
            border-radius: 4px;
            display: none;
        }
        
        .results.success {
            background: #e8f5e9;
            border: 1px solid #4CAF50;
        }
        
        .results.error {
            background: #ffebee;
            border: 1px solid #f44336;
        }
        
        .results.warning {
            background: #fff3e0;
            border: 1px solid #ff9800;
        }
        
        .error-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .error-item {
            background: white;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-left: 3px solid #f44336;
        }
        
        .instructions {
            background: #f5f5f5;
            padding: 1.5rem;
            border-radius: 4px;
            margin-bottom: 2rem;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #333;
        }
        
        .instructions ul {
            margin: 0.5rem 0;
        }
        
        .download-link {
            color: #4CAF50;
            text-decoration: none;
        }
        
        .download-link:hover {
            text-decoration: underline;
        }
        
        .form-group {
            margin-bottom: 2rem;
        }
        
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
            font-size: 1.1rem;
        }
        
        .category-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .category-select:hover {
            border-color: #4CAF50;
        }
        
        .category-select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="nav-container">
            <h1>AutoRevise - Admin MCQ Upload</h1>
            <div class="nav-links">
                <a href="dashboard-connected.html">Dashboard</a>
                <a href="admin-mcq-upload.html" class="active">MCQ Upload</a>
                <button onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <div class="upload-container">
        <h2>üìö Bulk Upload MCQ Questions</h2>
        
        <div class="instructions">
            <h3>Instructions:</h3>
            <ul>
                <li>Select a category for your questions</li>
                <li>Prepare a CSV file with MCQ questions</li>
                <li>Required columns: <code>question_text, option_a, option_b, option_c, option_d, correct_option, deck_id</code></li>
                <li>Optional columns: <code>explanation, difficulty, category_id</code></li>
                <li>Correct option must be A, B, C, or D</li>
                <li>Difficulty must be easy, medium, or hard</li>
                <li>Download <a href="../Backened/sample_mcqs.csv" class="download-link" download>sample template</a></li>
            </ul>
        </div>

        <!-- Category Selection -->
        <div class="form-group">
            <label for="categorySelect">üìÇ Select Category:</label>
            <select id="categorySelect" class="category-select">
                <option value="">Loading categories...</option>
            </select>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üì§</div>
            <h3>Click to select or drag & drop CSV file</h3>
            <p>Maximum file size: 5MB</p>
            <input type="file" id="fileInput" class="file-input" accept=".csv">
        </div>

        <div class="selected-file" id="selectedFile">
            <strong>Selected:</strong> <span id="fileName"></span>
            <button onclick="clearFile()" style="float: right; background: #f44336; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Clear</button>
        </div>

        <button class="upload-btn" id="uploadBtn" onclick="uploadCSV()">
            Upload MCQs
        </button>

        <div class="results" id="results"></div>
    </div>

    <script src="js/api-app1.js"></script>
    <script>
        // api is already created in api-app1.js as a global instance
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const selectedFile = document.getElementById('selectedFile');
        const fileName = document.getElementById('fileName');
        const uploadBtn = document.getElementById('uploadBtn');
        const results = document.getElementById('results');
        const categorySelect = document.getElementById('categorySelect');
        
        let selectedCSV = null;

        // Load categories on page load
        async function loadCategories() {
            try {
                const response = await fetch('http://127.0.0.1:5000/mcq/categories', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load categories');
                }
                
                const data = await response.json();
                categorySelect.innerHTML = '<option value="">Select a category (optional)</option>';
                
                data.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.category_id;
                    option.textContent = `${cat.category_name} (${cat.question_count} questions)`;
                    categorySelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading categories:', error);
                categorySelect.innerHTML = '<option value="">Error loading categories</option>';
            }
        }

        // Check if user is admin
        async function checkAdminAccess() {
            try {
                console.log('Checking admin access...');
                
                // First check localStorage
                const localUser = api.getCurrentUser();
                console.log('LocalStorage user:', localUser);
                
                if (!localUser) {
                    console.log('No user in localStorage, redirecting to login');
                    window.location.href = 'login-page.html';
                    return;
                }
                
                // Then verify with backend
                const response = await fetch('http://127.0.0.1:5000/me', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.error('Session verification failed');
                    window.location.href = 'login-page.html';
                    return;
                }
                
                const data = await response.json();
                console.log('Backend user data:', data.user);
                
                if (!data.user.is_admin) {
                    console.log('User is not admin, redirecting to dashboard');
                    alert('Access denied: Admin privileges required');
                    window.location.href = 'dashboard-connected.html';
                    return;
                }
                
                console.log('‚úÖ Admin access granted');
                
            } catch (error) {
                console.error('Failed to verify admin access:', error);
                alert('Failed to verify admin access. Please try logging in again.');
                window.location.href = 'login-page.html';
            }
        }

        // Initialize
        async function init() {
            await checkAdminAccess();
            await loadCategories();
        }
        
        init();

        // Click to upload
        uploadArea.addEventListener('click', () => fileInput.click());

        // File selection
        fileInput.addEventListener('change', (e) => {
            handleFileSelect(e.target.files[0]);
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            handleFileSelect(e.dataTransfer.files[0]);
        });

        function handleFileSelect(file) {
            if (!file) return;

            if (!file.name.endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }

            selectedCSV = file;
            fileName.textContent = file.name;
            selectedFile.style.display = 'block';
            uploadBtn.style.display = 'block';
            results.style.display = 'none';
        }

        function clearFile() {
            selectedCSV = null;
            fileInput.value = '';
            selectedFile.style.display = 'none';
            uploadBtn.style.display = 'none';
            results.style.display = 'none';
        }

        async function uploadCSV() {
            if (!selectedCSV) return;

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            results.style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('file', selectedCSV);
                
                // Add category_id if selected
                const selectedCategory = categorySelect.value;
                if (selectedCategory) {
                    formData.append('category_id', selectedCategory);
                }

                const response = await fetch('http://127.0.0.1:5000/mcq/upload', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const data = await response.json();

                if (response.ok || response.status === 207) {
                    displayResults(data, response.status);
                    // Reload categories to update question counts
                    await loadCategories();
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                results.className = 'results error';
                results.innerHTML = `<strong>‚ùå Error:</strong> ${error.message}`;
                results.style.display = 'block';
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload MCQs';
            }
        }

        function displayResults(data, status) {
            results.style.display = 'block';

            if (data.failed === 0) {
                // Complete success
                results.className = 'results success';
                results.innerHTML = `
                    <h3>‚úÖ Upload Successful!</h3>
                    <p><strong>Total processed:</strong> ${data.total_processed}</p>
                    <p><strong>Successfully imported:</strong> ${data.successful}</p>
                    <p>All MCQs have been added to the database.</p>
                `;
                clearFile();
            } else if (data.successful > 0) {
                // Partial success
                results.className = 'results warning';
                results.innerHTML = `
                    <h3>‚ö†Ô∏è Partial Success</h3>
                    <p><strong>Total processed:</strong> ${data.total_processed}</p>
                    <p><strong>Successfully imported:</strong> ${data.successful}</p>
                    <p><strong>Failed:</strong> ${data.failed}</p>
                    ${displayErrors(data.errors)}
                `;
            } else {
                // Complete failure
                results.className = 'results error';
                results.innerHTML = `
                    <h3>‚ùå Upload Failed</h3>
                    <p><strong>Total processed:</strong> ${data.total_processed}</p>
                    <p><strong>Failed:</strong> ${data.failed}</p>
                    ${displayErrors(data.errors)}
                `;
            }
        }

        function displayErrors(errors) {
            if (!errors || errors.length === 0) return '';

            return `
                <h4>Errors:</h4>
                <div class="error-list">
                    ${errors.map(err => `
                        <div class="error-item">
                            <strong>Row ${err.row}:</strong> ${err.error}
                        </div>
                    `).join('')}
                    ${errors.length >= 10 ? '<p><em>Showing first 10 errors...</em></p>' : ''}
                </div>
            `;
        }

        function logout() {
            api.logout().then(() => {
                window.location.href = 'login-page.html';
            });
        }
    </script>
</body>
</html>
