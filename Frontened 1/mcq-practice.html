<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCQ Practice | AutoRevise</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/config.js"></script>
    <style>
        .mcq-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .mcq-header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        /* Category Grid */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .category-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border-color: #4CAF50;
        }

        .category-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #4CAF50;
        }

        .category-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .category-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .category-count {
            background: #4CAF50;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
        }

        .mcq-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-box {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box h3 {
            margin: 0;
            font-size: 2rem;
            color: #4CAF50;
        }

        .stat-box p {
            margin: 0.5rem 0 0 0;
            color: #666;
        }

        .back-button {
            background: #2196F3;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
            margin-bottom: 1rem;
        }

        .back-button:hover {
            background: #1976D2;
        }

        .mcq-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .mcq-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .mcq-number {
            background: #2196F3;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: bold;
        }

        .difficulty-badge {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: bold;
            text-transform: capitalize;
        }

        .difficulty-easy { background: #4CAF50; color: white; }
        .difficulty-medium { background: #FF9800; color: white; }
        .difficulty-hard { background: #F44336; color: white; }

        .question-text {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 2rem;
            line-height: 1.6;
            color: #333;
        }

        .mcq-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .mcq-option {
            display: flex;
            align-items: center;
            padding: 1.2rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mcq-option:hover:not(.disabled) {
            border-color: #2196F3;
            background: #f5f9ff;
            transform: translateX(5px);
        }

        .mcq-option.selected {
            border-color: #2196F3;
            background: #e3f2fd;
        }

        .mcq-option.correct {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .mcq-option.incorrect {
            border-color: #F44336;
            background: #ffebee;
        }

        .mcq-option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .option-letter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.1rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .mcq-option.selected .option-letter {
            background: #1976D2;
        }

        .mcq-option.correct .option-letter {
            background: #4CAF50;
        }

        .mcq-option.incorrect .option-letter {
            background: #F44336;
        }

        .option-text {
            flex: 1;
            font-size: 1.1rem;
        }

        .submit-btn {
            width: 100%;
            padding: 1rem;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: all 0.3s;
        }

        .submit-btn:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .feedback {
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 10px;
            display: none;
        }

        .feedback.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback.correct {
            background: #e8f5e9;
            border: 2px solid #4CAF50;
        }

        .feedback.incorrect {
            background: #ffebee;
            border: 2px solid #F44336;
        }

        .feedback-icon {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .feedback h3 {
            text-align: center;
            margin: 0.5rem 0;
        }

        .explanation {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            font-style: italic;
        }

        .next-btn {
            width: 100%;
            padding: 1rem;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 1rem;
        }

        .next-btn:hover {
            background: #1976D2;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .empty-state i {
            font-size: 4rem;
            color: #ccc;
            margin-bottom: 1rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
        }

        .progress-bar {
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            height: 10px;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            color: #666;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <span>AutoRevise</span>
            </div>
            <div class="nav-links">
                <a href="dashboard-connected.html" class="nav-link">Dashboard</a>
                <a href="mcq-practice.html" class="nav-link active">MCQ Practice</a>
                <a href="achievements.html" class="nav-link">Achievements</a>
            </div>
            <div class="nav-user">
                <span id="username">Loading...</span>
                <button class="logout-btn" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="mcq-container">
        <!-- Categories View -->
        <div id="categoriesView">
            <div class="mcq-header">
                <h1>üìö MCQ Practice by Category</h1>
                <p>Select a category to start practicing</p>
            </div>

            <div class="category-grid" id="categoryGrid">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #2196F3;"></i>
                    <p>Loading categories...</p>
                </div>
            </div>
        </div>

        <!-- Practice View -->
        <div id="practiceView" style="display: none;">
            <button class="back-button" onclick="showCategories()">
                <i class="fas fa-arrow-left"></i> Back to Categories
            </button>

            <div class="mcq-header">
                <h1 id="categoryTitle">üìù MCQ Practice</h1>
                <div class="mcq-stats" id="mcqStats">
                    <div class="stat-box">
                        <h3 id="totalMCQs">-</h3>
                        <p>Total MCQs</p>
                    </div>
                    <div class="stat-box">
                        <h3 id="attempted">-</h3>
                        <p>Attempted</p>
                    </div>
                    <div class="stat-box">
                        <h3 id="accuracy">-</h3>
                        <p>Accuracy</p>
                    </div>
                    <div class="stat-box">
                        <h3 id="pointsEarned">0</h3>
                        <p>Points Today</p>
                    </div>
                </div>
            </div>

            <!-- Progress -->
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText"></div>

            <!-- Loading State -->
            <div class="loading" id="loadingState" style="display: none;">
                <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #2196F3;"></i>
                <p>Loading MCQs...</p>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-inbox"></i>
                <h2>No MCQs Available</h2>
                <p>There are no MCQs in this category yet.</p>
                <p>Ask your admin to upload more questions!</p>
            </div>

            <!-- MCQ Display -->
            <div class="mcq-card" id="mcqCard" style="display: none;">
                <!-- Content will be dynamically inserted -->
            </div>
        </div>
    </div>

    <script src="js/api-app1.js"></script>
    <script>
        let categories = [];
        let currentCategoryId = null;
        let mcqs = [];
        let currentIndex = 0;
        let selectedAnswer = null;
        let pointsEarnedToday = 0;
        let correctToday = 0;
        let attemptedToday = 0;

        // Initialize - Load Categories
        async function init() {
            try {
                console.log('MCQ Practice - Initializing...');
                
                // Check login
                if (!api.isLoggedIn()) {
                    console.log('User not logged in, redirecting...');
                    window.location.href = 'login-page.html';
                    return;
                }

                const user = api.getCurrentUser();
                console.log('Current user:', user);
                document.getElementById('username').textContent = user.username;

                // Load categories
                console.log('Loading categories...');
                await loadCategories();

            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to load categories. Please try again.');
            }
        }

        async function loadCategories() {
            try {
                console.log('Fetching categories from API...');
                const response = await fetch('http://127.0.0.1:5000/mcq/categories', {
                    credentials: 'include'
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('Failed to load categories:', errorData);
                    throw new Error(errorData.error || 'Failed to load categories');
                }

                const data = await response.json();
                console.log('Categories loaded:', data);
                categories = data.categories;

                displayCategories();

            } catch (error) {
                console.error('Error loading categories:', error);
                document.getElementById('categoryGrid').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h2>Error Loading Categories</h2>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.8rem 2rem; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        function displayCategories() {
            const categoryGrid = document.getElementById('categoryGrid');
            console.log('Displaying categories. Total:', categories.length);

            if (categories.length === 0) {
                categoryGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h2>No Categories Available</h2>
                        <p>No MCQ categories have been set up yet.</p>
                    </div>
                `;
                return;
            }

            const cardsHTML = categories.map(cat => {
                console.log('Creating card for:', cat.category_name);
                return `
                    <div class="category-card" onclick="selectCategory(${cat.category_id}, '${cat.category_name}')">
                        <div class="category-icon">
                            <i class="fas ${cat.icon}"></i>
                        </div>
                        <div class="category-name">${cat.category_name}</div>
                        <div class="category-description">${cat.description}</div>
                        <div class="category-count">
                            ${cat.question_count} question${cat.question_count !== 1 ? 's' : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('Setting innerHTML with', categories.length, 'category cards');
            categoryGrid.innerHTML = cardsHTML;
        }

        async function selectCategory(categoryId, categoryName) {
            currentCategoryId = categoryId;
            document.getElementById('categoryTitle').innerHTML = `üìù ${categoryName}`;

            // Switch views
            document.getElementById('categoriesView').style.display = 'none';
            document.getElementById('practiceView').style.display = 'block';

            // Load MCQs for this category
            await loadMCQsForCategory(categoryId);
        }

        function showCategories() {
            document.getElementById('practiceView').style.display = 'none';
            document.getElementById('categoriesView').style.display = 'block';
            resetPracticeSession();
        }

        function resetPracticeSession() {
            mcqs = [];
            currentIndex = 0;
            selectedAnswer = null;
            pointsEarnedToday = 0;
            correctToday = 0;
            attemptedToday = 0;
        }

        async function loadMCQsForCategory(categoryId) {
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const mcqCard = document.getElementById('mcqCard');
            const progressBar = document.getElementById('progressBar');

            loadingState.style.display = 'block';
            emptyState.style.display = 'none';
            mcqCard.style.display = 'none';
            progressBar.style.display = 'none';

            try {
                const response = await fetch(`http://127.0.0.1:5000/mcq/category/${categoryId}`, {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load MCQs');

                const data = await response.json();
                mcqs = data.mcqs;

                loadingState.style.display = 'none';

                if (mcqs.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    // Load stats
                    await loadStats();
                    // Show first MCQ
                    currentIndex = 0; // Reset to first question
                    renderCurrentMCQ();
                    progressBar.style.display = 'block';
                }

            } catch (error) {
                console.error('Error loading MCQs:', error);
                loadingState.style.display = 'none';
                emptyState.style.display = 'block';
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('http://127.0.0.1:5000/mcq/stats', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalMCQs').textContent = data.stats.total_mcqs_attempted || 0;
                    document.getElementById('attempted').textContent = data.stats.total_attempts || 0;
                    document.getElementById('accuracy').textContent = data.stats.avg_accuracy ? `${data.stats.avg_accuracy}%` : '0%';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadMCQs() {
            try {
                const response = await fetch('http://127.0.0.1:5000/mcq/study-session?limit=20', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load MCQs');
                }

                const data = await response.json();
                mcqs = data.mcqs || [];

                document.getElementById('loadingState').style.display = 'none';

                if (mcqs.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    document.getElementById('progressBar').style.display = 'block';
                    renderCurrentMCQ();
                }

            } catch (error) {
                console.error('Error loading MCQs:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        function renderCurrentMCQ() {
            if (currentIndex >= mcqs.length) {
                showCompletionScreen();
                return;
            }

            const mcq = mcqs[currentIndex];
            selectedAnswer = null;

            // Update progress
            const progress = ((currentIndex + 1) / mcqs.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `Question ${currentIndex + 1} of ${mcqs.length}`;

            // Render MCQ
            const mcqCard = document.getElementById('mcqCard');
            mcqCard.style.display = 'block';
            mcqCard.innerHTML = `
                <div class="mcq-question-header">
                    <div class="mcq-number">Question ${currentIndex + 1}</div>
                    <div class="difficulty-badge difficulty-${mcq.difficulty}">${mcq.difficulty}</div>
                </div>

                <div class="question-text">${mcq.question_text}</div>

                <div class="mcq-options">
                    <div class="mcq-option" onclick="selectOption('A', this)">
                        <div class="option-letter">A</div>
                        <div class="option-text">${mcq.option_a}</div>
                    </div>
                    <div class="mcq-option" onclick="selectOption('B', this)">
                        <div class="option-letter">B</div>
                        <div class="option-text">${mcq.option_b}</div>
                    </div>
                    <div class="mcq-option" onclick="selectOption('C', this)">
                        <div class="option-letter">C</div>
                        <div class="option-text">${mcq.option_c}</div>
                    </div>
                    <div class="mcq-option" onclick="selectOption('D', this)">
                        <div class="option-letter">D</div>
                        <div class="option-text">${mcq.option_d}</div>
                    </div>
                </div>

                <button class="submit-btn" id="submitBtn" onclick="submitAnswer()" disabled>
                    Submit Answer
                </button>

                <div class="feedback" id="feedback"></div>
            `;
        }

        function selectOption(option, element) {
            // Remove previous selection
            document.querySelectorAll('.mcq-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Mark new selection
            element.classList.add('selected');
            selectedAnswer = option;

            // Enable submit button
            document.getElementById('submitBtn').disabled = false;
        }

        async function submitAnswer() {
            if (!selectedAnswer) return;

            const mcq = mcqs[currentIndex];
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Checking...';

            try {
                const response = await fetch(`http://127.0.0.1:5000/mcq/${mcq.mcq_id}/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ answer: selectedAnswer })
                });

                if (!response.ok) {
                    throw new Error('Failed to check answer');
                }

                const result = await response.json();

                // Update stats
                attemptedToday++;
                if (result.correct) {
                    correctToday++;
                    pointsEarnedToday += result.points_earned;
                }
                document.getElementById('pointsEarned').textContent = pointsEarnedToday;

                // Disable all options
                document.querySelectorAll('.mcq-option').forEach(opt => {
                    opt.classList.add('disabled');
                    opt.onclick = null;
                });

                // Highlight correct/incorrect answers
                const options = document.querySelectorAll('.mcq-option');
                const letters = ['A', 'B', 'C', 'D'];
                options.forEach((opt, index) => {
                    if (letters[index] === result.correct_answer) {
                        opt.classList.add('correct');
                    } else if (opt.classList.contains('selected')) {
                        opt.classList.add('incorrect');
                    }
                });

                // Show feedback
                showFeedback(result);

            } catch (error) {
                console.error('Error submitting answer:', error);
                alert('Failed to submit answer. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Answer';
            }
        }

        function showFeedback(result) {
            const feedback = document.getElementById('feedback');
            feedback.className = `feedback show ${result.correct ? 'correct' : 'incorrect'}`;

            feedback.innerHTML = `
                <div class="feedback-icon">${result.correct ? '‚úÖ' : '‚ùå'}</div>
                <h3>${result.correct ? 'Correct!' : 'Incorrect'}</h3>
                ${result.correct ? 
                    `<p>Great job! You earned <strong>${result.points_earned} points</strong></p>` :
                    `<p>The correct answer was: <strong>${result.correct_answer}</strong></p>`
                }
                ${result.explanation ? `<div class="explanation"><strong>Explanation:</strong> ${result.explanation}</div>` : ''}
                <button class="next-btn" onclick="nextMCQ()">
                    ${currentIndex + 1 < mcqs.length ? 'Next Question' : 'Finish'} ‚Üí
                </button>
            `;
        }

        function nextMCQ() {
            currentIndex++;
            renderCurrentMCQ();
        }

        function showCompletionScreen() {
            const mcqCard = document.getElementById('mcqCard');
            const accuracy = attemptedToday > 0 ? Math.round((correctToday / attemptedToday) * 100) : 0;

            mcqCard.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üéâ</div>
                    <h2>Practice Session Complete!</h2>
                    <div class="mcq-stats" style="margin: 2rem 0;">
                        <div class="stat-box">
                            <h3>${attemptedToday}</h3>
                            <p>Questions Answered</p>
                        </div>
                        <div class="stat-box">
                            <h3>${correctToday}</h3>
                            <p>Correct Answers</p>
                        </div>
                        <div class="stat-box">
                            <h3>${accuracy}%</h3>
                            <p>Accuracy</p>
                        </div>
                        <div class="stat-box">
                            <h3>${pointsEarnedToday}</h3>
                            <p>Points Earned</p>
                        </div>
                    </div>
                    <button onclick="window.location.href='dashboard-connected.html'" class="next-btn">
                        Back to Dashboard
                    </button>
                    <button onclick="location.reload()" class="next-btn" style="background: #4CAF50;">
                        Practice More MCQs
                    </button>
                </div>
            `;
        }

        function handleLogout() {
            api.logout().then(() => {
                window.location.href = 'login-page.html';
            });
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
